!(function () {
  tinymce.create("tinymce.plugins.BBCodePlugin", {
    init: function (a) {
      var b = this,
        c = a.getParam("bbcode_dialect", "punbb").toLowerCase();
      a.on("beforeSetContent", function (a) {
        a.content = b["_" + c + "_bbcode2html"](a.content);
      }),
        a.on("postProcess", function (a) {
          a.set && (a.content = b["_" + c + "_bbcode2html"](a.content)),
            a.get && (a.content = b["_" + c + "_html2bbcode"](a.content));
        });
    },
    getInfo: function () {
      return {
        longname: "BBCode Plugin",
        author: "Ephox Corp",
        authorurl: "http://www.tinymce.com",
        infourl: "http://www.tinymce.com/wiki.php/Plugin:bbcode",
      };
    },
    _punbb_html2bbcode: function (a) {
      function b(b, c) {
        a = a.replace(b, c);
      }
      return (
        (a = tinymce.trim(a)),
        b(/<a.*?href=\"(.*?)\".*?>(.*?)<\/a>/gi, "[url=$1]$2[/url]"),
        b(
          /<font.*?color=\"(.*?)\".*?className=\"codeStyle\".*?>(.*?)<\/font>/gi,
          "[code][color=$1]$2[/color][/code]"
        ),
        b(
          /<font.*?color=\"(.*?)\".*?className=\"quoteStyle\".*?>(.*?)<\/font>/gi,
          "[quote][color=$1]$2[/color][/quote]"
        ),
        b(
          /<font.*?className=\"codeStyle\".*?color=\"(.*?)\".*?>(.*?)<\/font>/gi,
          "[code][color=$1]$2[/color][/code]"
        ),
        b(
          /<font.*?className=\"quoteStyle\".*?color=\"(.*?)\".*?>(.*?)<\/font>/gi,
          "[quote][color=$1]$2[/color][/quote]"
        ),
        b(
          /<span style=\"color: ?(.*?);\">(.*?)<\/span>/gi,
          "[color=$1]$2[/color]"
        ),
        b(/<font.*?color=\"(.*?)\".*?>(.*?)<\/font>/gi, "[color=$1]$2[/color]"),
        b(
          /<span style=\"font-size:(.*?);\">(.*?)<\/span>/gi,
          "[size=$1]$2[/size]"
        ),
        b(/<font>(.*?)<\/font>/gi, "$1"),
        b(/<img.*?src=\"(.*?)\".*?\/>/gi, "[img]$1[/img]"),
        b(/<span className=\"codeStyle\">(.*?)<\/span>/gi, "[code]$1[/code]"),
        b(
          /<span className=\"quoteStyle\">(.*?)<\/span>/gi,
          "[quote]$1[/quote]"
        ),
        b(
          /<strong className=\"codeStyle\">(.*?)<\/strong>/gi,
          "[code][b]$1[/b][/code]"
        ),
        b(
          /<strong className=\"quoteStyle\">(.*?)<\/strong>/gi,
          "[quote][b]$1[/b][/quote]"
        ),
        b(
          /<em className=\"codeStyle\">(.*?)<\/em>/gi,
          "[code][i]$1[/i][/code]"
        ),
        b(
          /<em className=\"quoteStyle\">(.*?)<\/em>/gi,
          "[quote][i]$1[/i][/quote]"
        ),
        b(/<u className=\"codeStyle\">(.*?)<\/u>/gi, "[code][u]$1[/u][/code]"),
        b(
          /<u className=\"quoteStyle\">(.*?)<\/u>/gi,
          "[quote][u]$1[/u][/quote]"
        ),
        b(/<\/(strong|b)>/gi, "[/b]"),
        b(/<(strong|b)>/gi, "[b]"),
        b(/<\/(em|i)>/gi, "[/i]"),
        b(/<(em|i)>/gi, "[i]"),
        b(/<\/u>/gi, "[/u]"),
        b(
          /<span style=\"text-decoration: ?underline;\">(.*?)<\/span>/gi,
          "[u]$1[/u]"
        ),
        b(/<u>/gi, "[u]"),
        b(/<blockquote[^>]*>/gi, "[quote]"),
        b(/<\/blockquote>/gi, "[/quote]"),
        b(/<br \/>/gi, "\n"),
        b(/<br\/>/gi, "\n"),
        b(/<br>/gi, "\n"),
        b(/<p>/gi, ""),
        b(/<\/p>/gi, "\n"),
        b(/&nbsp;|\u00a0/gi, " "),
        b(/&quot;/gi, '"'),
        b(/&lt;/gi, "<"),
        b(/&gt;/gi, ">"),
        b(/&amp;/gi, "&"),
        a
      );
    },
    _punbb_bbcode2html: function (a) {
      function b(b, c) {
        a = a.replace(b, c);
      }
      return (
        (a = tinymce.trim(a)),
        b(/\n/gi, "<br />"),
        b(/\[b\]/gi, "<strong>"),
        b(/\[\/b\]/gi, "</strong>"),
        b(/\[i\]/gi, "<em>"),
        b(/\[\/i\]/gi, "</em>"),
        b(/\[u\]/gi, "<u>"),
        b(/\[\/u\]/gi, "</u>"),
        b(/\[url=([^\]]+)\](.*?)\[\/url\]/gi, '<a href="$1">$2</a>'),
        b(/\[url\](.*?)\[\/url\]/gi, '<a href="$1">$1</a>'),
        b(/\[img\](.*?)\[\/img\]/gi, '<img src="$1" />'),
        b(/\[color=(.*?)\](.*?)\[\/color\]/gi, '<font color="$1">$2</font>'),
        b(
          /\[code\](.*?)\[\/code\]/gi,
          '<span className="codeStyle">$1</span>&nbsp;'
        ),
        b(
          /\[quote.*?\](.*?)\[\/quote\]/gi,
          '<span className="quoteStyle">$1</span>&nbsp;'
        ),
        a
      );
    },
  }),
    tinymce.PluginManager.add("bbcode", tinymce.plugins.BBCodePlugin);
})();
